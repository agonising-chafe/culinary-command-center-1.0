# Agent Context for Culinary Command Center

This document orients code-assist agents ("Codex") to work quickly and safely in this repository.

## Project Overview
- Framework: Next.js (App Router), TypeScript, React, Tailwind
- State: Zustand store in lib/useRecipeStore.ts
- Backend: Supabase (via @supabase/supabase-js) or mock fallback
- PWA: next-pwa with dev/offline safeguards and update UX
- Dev environment: VS Code Dev Container (.devcontainer/) with Node 20

Key documents
- Quick start and deploy: README.md
- System blueprint (architecture, API, data flow): docs/BLUEPRINT.md

## Run and Build
- Dev: npm run dev then open http://localhost:3000
- Prod: npm run build && npm run start
- Health check: GET /api/health

## Environment Variables (Supabase)
Define in .env.local (both local and on Vercel):
- NEXT_PUBLIC_SUPABASE_URL
- NEXT_PUBLIC_SUPABASE_ANON_KEY
- NEXT_PUBLIC_SUPABASE_SCHEMA (optional, default public)
- NEXT_PUBLIC_SUPABASE_IMAGE_COLUMN (optional, image_url or image)

## Data Model (Supabase)
Table recipes (schema configurable):
- id uuid primary key default gen_random_uuid()
- name text not null
- image_url text (UI also supports image)
- time int default 0
- calories int default 0
- ingredients jsonb default [] (array of strings)
- instructions jsonb default [] (array of strings)

Safe migration snippet lives in docs/BLUEPRINT.md.

## API Surface
- CRUD: app/api/recipes/route.ts (GET, POST, PUT, DELETE)
- Health: app/api/health/route.ts (env + reachability)
- Legacy probe: app/api/test-db/route.ts
Notes
- API returns { ok: boolean, ... } and never crashes on missing env (returns JSON 500 instead).
- Routes export runtime='nodejs' and preferredRegion hints.

## Store (Frontend)
lib/useRecipeStore.ts
- Actions: initialize, refresh, saveRecipe, deleteRecipe
- Behavior: one retry with backoff before fallback to mock
- Mapping: tolerates image_url or image; normalizes arrays and numbers

## UI Patterns
- Planner UI: components/PlannerGrid.tsx
- Recipe modal: components/RecipeModal.tsx
  - Edit Mode shows inputs (name, time, calories, ingredients, instructions)
  - Save/Delete call store actions; toasts confirm success
- Navbar: components/Navbar.tsx shows Live DB vs Mock (configure DB) and links to /api/health
- PWA helpers: components/DevSwUnregister.tsx, components/SWUpdatePrompt.tsx, components/UpdateButton.tsx, components/RefreshToast.tsx

## PWA
- Enabled in production; disabled in development
- Service worker generated by next-pwa
- Dev unregister plus cache clear prevents stale chunk 404s

## Dev Container
- Config: .devcontainer/devcontainer.json plus Dockerfile
- Node 20, ripgrep, git, curl; Corepack with pnpm/yarn/npm
- Port 3000 auto-forwarded; postCreateCommand installs deps

## Coding Conventions
- TypeScript, React function components
- Keep changes minimal and focused; do not introduce global rewrites
- Prefer explicit names over one-letter variables
- No license header changes; do not alter unrelated files
- Follow existing file structure and styling

## Agent Safety and Scope
- Work only inside the repository; do not assume access outside it
- Do not exfiltrate or print secrets; keep .env.local out of commits
- For migrations, prefer SQL in docs and avoid destructive changes
- For PWA, do not commit generated public/sw.js or workbox-* (ignored)

## Common Tasks Cheat-Sheet
- Add API: place under app/api/<name>/route.ts and export method handlers
- Fetch in store: call /api/... and map to Recipe shape in lib/useRecipeStore.ts
- UI change: implement in components/* and wire with the store; keep Edit/View modes intact
- Validate: run npm run build locally; verify /api/health and /api/recipes

## Known Decisions
- Manifest served at /manifest.webmanifest with static file in public/
- Mock images use /placeholder.svg to avoid optimizer 400s
- Regions preference set per route; not in vercel.json

When in doubt, prefer small, testable changes and update docs/BLUEPRINT.md or README.md when behavior changes.

## Contribution Guide (for Agents)
- Branching
  - Create a feature branch per change (e.g., `feat/api-crud`, `fix/pwa-cache`, `docs/blueprint`). If branching isn’t available, keep commits scoped and descriptive.
- Commit style
  - Use imperative, scoped messages: `feat(store): add retry backoff`, `fix(ui): disable save on invalid form`, `docs: add agent context`.
  - One logical change per commit; avoid mixing unrelated edits.
- Pull requests (if applicable)
  - Keep PRs small and focused. Include a brief summary, affected files, and verification steps (build, endpoints tested).
  - Reference any follow‑ups explicitly.
- Code style
  - Match existing patterns (TypeScript, functional React, clear names). Avoid one‑letter vars; prefer small, pure helpers.
- Testing/validation
  - Run `npm run build` locally. Manually hit `/api/health` and `/api/recipes` if you touched API/store.
- Safety checklist
  - No secrets in code or logs; `.env.local` stays uncommitted.
  - Don’t commit generated `public/sw.js` or `workbox-*`.
  - Avoid destructive DB changes; provide SQL in docs when needed.
